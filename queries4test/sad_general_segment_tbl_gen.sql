CREATE OR REPLACE TABLE sydonia_opendata.sad_general_segment AS
SELECT 
  instanceid,
  rls_cuo_cod,
  rls_cuo_nam,
  rls_ref,
  rls_inf,
  rls_dat,
  rls_tim,
  prv_dty,
  pty_wde,
  pty_frm_nbr,
  pty_frm_tot,
  pty_nbr_ldl,
  pty_nbr_itm,
  pty_nbr_pck,
  pty_plc,
  pty_cde,
  ide_cuo_cod,
  ide_cuo_nam,
  ide_typ_sad,
  ide_typ_prc,
  ide_typ_typ,
  ide_typ_trs,
  ide_man,
  ide_bar,
  ide_reg_ser,
  ide_reg_nbr,
  ide_reg_dat,
  ide_ast_ser,
  ide_ast_nbr,
  ide_ast_dat,
  ide_rcp_ser,
  ide_rcp_nbr,
  ide_rcp_dat,
  ide_rcp_typ,
  ide_rcp_cuo,
  ide_pst_nbr,
  ide_pst_dat,
  ide_pst_tmp_pre,
  ide_pst_tmp_ty1,
  ide_pst_tmp_ty2,
  cmp_exp_cod,
  cmp_exp_nam,
  cmp_con_cod,
  cmp_con_nam,
  cmp_fis_cod,
  cmp_fis_nam,
  dec_flg,
  dec_cod,
  dec_nam,
  dec_ref_yer,
  dec_ref_nbr,
  dec_rep,
  gen_cty_flt,
  gen_cty_trd,
  gen_cty_ept_cod,
  gen_cty_ept_nam,
  gen_cty_ept_crg,
  gen_cty_des_cod,
  gen_cty_des_nam,
  gen_cty_des_crg,
  gen_cty_org,
  gen_vdt,
  gen_cap,
  gen_fre,
  -- utilisation de regexp_replace compatible BigQuery
  REGEXP_REPLACE(tpt_mot_dpa_nam, r'[^\\x00-\\x7FéÉàâäèêëïîôöùüçÉÀÂÄÈÊËÏÎÔÖÙÜÇ]', ' ') AS tpt_mot_dpa_nam,
  tpt_mot_dpa_cty,
  tpt_mot_brd_nam,
  tpt_mot_brd_cty,
  tpt_mot_brd_cod,
  tpt_mot_inl,
  CASE WHEN tpt_ctf THEN 'O' ELSE 'N' END AS tpt_ctf,
  tpt_tod_cod,
  tpt_tod_plc,
  tpt_tod_sit,
  tpt_cuo_cod,
  tpt_cuo_nam,
  tpt_lop_cod,
  tpt_lop_nam,
  tpt_lop_cty,
  tpt_loc,
  tpt_t1,
  fin_tra_na1,
  fin_tra_na2,
  fin_bnk_cod,
  fin_bnk_nam,
  fin_bnk_bra,
  fin_bnk_fre,
  fin_top_cod,
  fin_top_nam,
  fin_acc,
  fin_pin,
  fin_mpn,
  fin_amt_mnl,
  fin_amt_fee,
  fin_amt_dty,
  fin_amt_tbp,
  fin_gty_nam,
  fin_gty_amt,
  fin_gty_dat,
  fin_gty_cty_cod,
  fin_gty_cty_nam,
  vgs_wrk,
  vgs_wgt_grs,
  vgs_cst,
  vgs_cif,
  vgs_tot_nmu,
  vgs_tot_fcx,
  vgs_tot_grs,
  vgs_inv_amt_nmu,
  vgs_inv_amt_fcx,
  vgs_inv_cur_cod,
  vgs_inv_cur_nam,
  vgs_inv_cur_rat,
  vgs_inv_cur_ref,
  vgs_efr_amt_nmu,
  vgs_efr_amt_fcx,
  vgs_efr_cur_cod,
  vgs_efr_cur_nam,
  vgs_efr_cur_rat,
  vgs_efr_cur_ref,
  vgs_ifr_amt_nmu,
  vgs_ifr_amt_fcx,
  vgs_ifr_cur_cod,
  vgs_ifr_cur_nam,
  vgs_ifr_cur_rat,
  vgs_ifr_cur_ref,
  vgs_ins_amt_nmu,
  vgs_ins_amt_fcx,
  vgs_ins_cur_cod,
  vgs_ins_cur_nam,
  vgs_ins_cur_rat,
  vgs_ins_cur_ref,
  vgs_otc_amt_nmu,
  vgs_otc_amt_fcx,
  vgs_otc_cur_cod,
  vgs_otc_cur_nam,
  vgs_otc_cur_rat,
  vgs_otc_cur_ref,
  vgs_ded_amt_nmu,
  vgs_ded_amt_fcx,
  vgs_ded_cur_cod,
  vgs_ded_cur_nam,
  vgs_ded_cur_rat,
  vgs_ded_cur_ref,
  whs_cod,
  whs_tim,
  trs_rsp_cod,
  trs_rsp_nam,
  trs_rsp_rep,
  trs_sgt_plc,
  trs_sgt_dat,
  trs_des_cuo,
  trs_des_cod,
  trs_des_cty,
  trs_sls_nbr,
  trs_sls_ide,
  trs_ctl,
  trs_lim,
  trs_cof,
  ast_ryr,
  ast_ayr,
  ast_tot,
  ast_amt,
  ast_stn,
  ast_std,
  ast_sts,
  rlo_nbr,
  exa_sec,
  exa_exa,
  exa_cex,
  exa_wgt,
  lst_rcp_amt,
  lst_rcp_ser,
  lst_rcp_nbr,
  lst_rcp_dat,
  lst_rcp_typ,
  lst_rcp_cuo,
  doc_ref_dat,
  doc_ref_nbr,
  pty_fac,
  pty_sts
FROM (
  SELECT 
    sg.*, 
    DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY) AS p_date
  FROM sydonia.sad_general_segment AS sg
) AS g
WHERE (
  COALESCE(ide_pst_dat, ide_ast_dat) >= p_date
  OR ide_rcp_dat >= p_date
  OR (ide_ast_dat IS NULL AND ide_reg_dat IS NOT NULL) -- toutes les provisoires
  OR (pty_sts = 'Cancelled') -- toutes les annulées
)
